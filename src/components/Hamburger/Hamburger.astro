---
import { getCollection } from "astro:content";
import Icon from "./_Icon.astro";
import ThemeSwitch from "../ThemeSwitch.astro";

const pages = await getCollection("pages");
---

<c-hamburger>
  <nav role="navigation" aria-label="Menu principal">
    <button aria-expanded="false" title="Menu">
      <Icon />
    </button>
    <div class="menu" style="display: none;">
      <ul role="list">
        <li><a href="/">Accueil</a></li>
        {
          pages.map((el) => (
            <li>
              <a href={`/${el.slug}`}>{el.data.title}</a>
            </li>
          ))
        }
        <li><a href="mailto:slt@charlescailleteau.com">Contact</a></li>
      </ul>
      <div class="themeSwitch">
        <ThemeSwitch/>
      </div>
    </div>
  </nav>
</c-hamburger>

<script>
  import { animate } from "motion";
  customElements.define(
    "c-hamburger",
    class Hamburger extends HTMLElement {
      #btn: HTMLButtonElement;
      #wrapper: HTMLElement;
      #isOpen = false;

      constructor() {
        super();
        this.#btn = this.querySelector("button")!;
        this.#wrapper = this.querySelector(".menu")!;
      }

      connectedCallback() {
        this.#btn.addEventListener("click", this.#handleClick);
      }

      disconnectedCallback() {
        this.#btn.removeEventListener("click", this.#handleClick);
      }

      #handleClick = () => {
        this.#isOpen = !this.#isOpen;
        if (this.#isOpen) this.#open();
        else this.#close();
      };

      #handleKeydown = (e: KeyboardEvent) => {
        if (e.code === "Escape") this.#close();
      };

      #open() {
        this.#wrapper.style.removeProperty("display");
        animate(this.#wrapper, {
          transform: ["translateX(100%)", "translateX(0)"],
        });
        document.addEventListener("keydown", this.#handleKeydown);
        this.#btn.setAttribute("aria-expanded", "true");
        document.documentElement.setAttribute("data-menu-open", "true");
      }

      async #close() {
        this.#btn.setAttribute("aria-expanded", "false");
        document.documentElement.setAttribute("data-menu-open", "false");
        document.removeEventListener("keydown", this.#handleKeydown);
        await animate(this.#wrapper, {
          transform: ["translateX(0)", "translateX(100%)"],
        }).finished;
        this.#wrapper.style.setProperty("display", "none");
      }
    }
  );
</script>

<style>
  :global([data-menu-open="true"]) {
    overflow: hidden;
  }

  nav {
    z-index: 1;
  }
  button {
    z-index: 9999;
    transition: color 0.4s;
  }
  .menu{
    position: fixed;
    z-index: -1;
    height: 100vh;
    right: 0;
    top: 0;
    width: 100vw;
  }

  ul {
    height: 100%;
    display: grid;
    align-content: center;
    gap: var(--space-xl);
    background: var(--gray-2);
    font-size: var(--step-4);
    border-inline-start: 1px solid var(--gray-5);
  }

  @media (width > 60rem) {
    .menu {
      width: 50vw;
    }
  }

  li {
    padding-inline: var(--space-xl);
  }

  nav a {
    color: var(--gray-11);
    text-decoration: none;
    transition: color .2s;
  }

  nav a:where(:hover,:focus-visible){
    color: var(--gray-12);
  }

  .themeSwitch{
    position: absolute;
    right: 0;
    bottom: 0;
  }
</style>
